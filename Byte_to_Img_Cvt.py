
import os
from PIL import Image
import numpy as np
import sys


DEBUG_MODE = True

root_dir = "C:\\"

def debug_print(fmt, *args) -> None:
    if DEBUG_MODE:
        print(fmt % args)

def debug_decorator(func) -> any:
    def wrapper(*args, **kwargs):
        if DEBUG_MODE:
            func_name = func.__name__
            arg_values = [repr(arg) for arg in args]
            kwargs_values = [f"{key}={repr(value)}" for key, value in kwargs.items()]
            arg_list = ", ".join(arg_values + kwargs_values)
            debug_print("[+] Calling %s(%s)", func_name, arg_list)
        return func(*args, **kwargs)
    return wrapper


@debug_decorator
def convert_exe_to_img(unsigned_bytes_array, index) -> None:
    debug_print("\t[+] Converting exe to image")
    row_width = 1024 
    num_rows = -(-len(unsigned_bytes_array) // row_width)  # Ceiling division
    # create zero'd array
    output_array = np.zeros((num_rows, row_width), dtype=np.uint8)
   
    # Fill the 2D array with values from the input_array
    for i in range(num_rows):
        start_idx = i * row_width
        end_idx = (i + 1) * row_width
        output_array[i, :len(unsigned_bytes_array[start_idx:end_idx])] = unsigned_bytes_array[start_idx:end_idx]

    # Convert the 2D array into a grayscale image
    image = Image.fromarray(output_array, 'L')

    # Save the image (optional)
    image.save(f"goodware_images/goodware_img_{str(index)}.png")

    return None

"""

"""
@debug_decorator
def PE_check(file_path:str) -> bool:

    try:
        with open(file_path, 'rb') as f:
            magic_bytes = f.read(2)
    except Exception as exe:
        debug_print("\t[-] Exception \"%s\"", str(exe))
        return False

    # check for bytes 0x4D 0x5A (MZ)
    if magic_bytes == b"MZ":
        debug_print("\t[+] True")
        f.close()
        return True
    else:
        debug_print("\t[+] False")
        f.close()
        return False

@debug_decorator
def read_exe_binary(file_path:str) -> list | None:
 
    with open(file_path, 'rb') as f:
        binary_data = f.read()

    unsigned_bytes_array = []

    if binary_data == None or len(binary_data) == 0:
        debug_print("\t[-] error reading binary data from %s into a file", file_path)
        return None
    
    """
    By default, when we access a byte from the bytes object, it returns a signed integer in the range of -128 to 127. 
    However, to store the bytes as unsigned integers in the array, we need to convert these signed integers to their equivalent unsigned representation.

    In Python, the conversion from signed to unsigned integers can be done with a simple arithmetic operation:

    If the byte's value is in the range of 0 to 127 (0x00 to 0x7F), the byte's signed and unsigned representation are the same.
    If the byte's value is in the range of -128 to -1 (0x80 to 0xFF), we add 256 to the signed value to obtain the corresponding unsigned value.
    """
    for byte in binary_data:
        unsigned_byte = byte if byte >=0 else byte + 256
        unsigned_bytes_array.append(unsigned_byte)

    return unsigned_bytes_array

@debug_decorator
def find_system_executables(root_dir):
    executables = []
    try:
        for root, dirs, files in os.walk(root_dir):
            for file in files:
                if len(executables) >= 1000:
                        break
                file_path = os.path.join(root, file)
                if PE_check(file_path):
                    executables.append(file_path)
                    
    except Exception as exe:
        print(f"[-] Error: {exe}")
        
    return executables



@debug_decorator
def main() -> None:

    """
    argv = sys.argv[1:]

    if len(argv) == 0:
        root_dir = "C:\\"
    elif len(argv) == 1:
        root_dir = str(argv[0])
    else:
        print("Usage Error")
        return None
    """
    

    system_executables = find_system_executables(root_dir)

    count = 0
    for file in system_executables:
        unsigned_bytes = read_exe_binary(file)
        if (unsigned_bytes != None):
            debug_print("\t[-] Error Reading Bytes")
            convert_exe_to_img(unsigned_bytes, count)
            count += 1
        else:
            pass
            
        
    return None


if __name__ == "__main__":
    main()